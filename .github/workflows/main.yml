import os
import json
import time
import requests
from datetime import datetime, timedelta
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By

def send_tg(msg):
    url = f"https://api.telegram.org/bot{os.environ['TG_TOKEN']}/sendMessage"
    payload = {"chat_id": os.environ['TG_CHAT_ID'], "text": msg, "parse_mode": "HTML"}
    try: requests.post(url, json=payload)
    except: pass

def run_crawler():
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    driver = webdriver.Chrome(options=options)
    
    all_history = {}
    for i in range(5):
        d = datetime.now() - timedelta(days=i)
        date_str = d.strftime('%Y-%m-%d')
        date_key = d.strftime('%Y%m%d')
        
        print(f"æ­£åœ¨æŠ“å– {date_str}...")
        driver.get(f"https://winwin.tw/Bingo?date={date_str}")
        time.sleep(6) # çµ¦äºˆè¶³å¤ è¼‰å…¥æ™‚é–“
        
        rows = driver.find_elements(By.TAG_NAME, "tr")
        day_data = []
        for row in rows:
            txt = row.text
            if ":" in txt and len(txt) > 40:
                parts = txt.split()
                if len(parts) >= 22:
                    day_data.append({
                        "issue": parts[0],
                        "time": parts[1],
                        "h": int(parts[1].split(':')[0]),
                        "nums": parts[2:22]
                    })
        all_history[date_key] = day_data
    
    with open('bingo_data.json', 'w', encoding='utf-8') as f:
        json.dump(all_history, f, ensure_ascii=False, indent=4)
    
    driver.quit()
    send_tg(f"âœ… <b>é›²ç«¯å‚™ä»½æˆåŠŸ</b>\nğŸ“… æ—¥æœŸï¼š{datetime.now().strftime('%Y-%m-%d %H:%M')}\nğŸ“‚ æª”æ¡ˆï¼šbingo_data.json å·²æ›´æ–°")

if __name__ == "__main__":
    run_crawler()
